{% extends 'base.html' %}
{% block title %}Holmes Run{% endblock %}
{% block content %}

  <form action="/login-complete" method="POST">
    <label>Email:</label>
      <input type="email" name="email" placeholder="email" required>
    <label>Password:</label>
      <input type="password" name="password" placeholder="password" required>
      <input type="submit" value="Login">
  </form>
  <hr>

  <p>Answer these three simple questions and we will generate a running plan 
    to help you reach your running goals.</p>
  <form action="/plan.json" method="POST" id="planning-form" required>
    How far can you run today without stopping?:
      <select id="current-ability" name="current-ability" required>
        <option value="---">---</option>
        <option value="0">Less than a mile</option>
        <option value="1">1 mile</option>
        <option value="2">2 miles</option>
        <option value="3">3 miles</option>
        <option value="4">4 miles</option>
        <option value="5">5 miles</option>
        <option selected="selected" value="6">6 miles</option>
        <option value="7">7 miles</option>
        <option value="8">8 miles</option>
        <option value="9">9 miles</option>
        <option value="10">10 miles</option>
        <option value="11">11 miles</option>
        <option value="12">12 miles</option>
        <option value="13">13 miles</option>
        <option value="14">14 miles</option>
        <option value="15">15 miles</option>
        <option value="16">16 miles</option>
        <option value="17">17 miles</option>
        <option value="18">18 miles</option>
        <option value="19">19 miles</option>
        <option value="20">20 miles</option>
        <option value="21">21 miles</option>
        <option value="22">22 miles</option>
        <option value="23">23 miles</option>
        <option value="24">24 miles</option>
        <option value="25">25 miles</option>
        <option value="26+">26 miles</option>
      </select><br><br>
      What is your running goal (event or distance)?:
      <select id="goal-distance" name="goal-distance" required>
        <option value="---">---</option>
        <option value="3.1">5K (3.1 miles)</option>
        <option value="5">5 miles</option>
        <option value="6.2">10K (6.2 miles)</option>
        <option value="10">10 miles</option>
        <option selected="selected" value="13.1">Half Marathon (13.1 miles)</option>
        <option value="26.2">Marathon (26.2 miles)</option>
      </select><br><br>
      What date will your event/goal take place?
      <input type="date" id="goal-date" value="2017-06-03" name="goal-date"><br><br>
      <input type="submit" id="generate-plan" name="generate-plan" value="Generate Plan!">
  </form><br><br>
  
  <table id="plan-calendar" name="plan-calendar" border="1px" hidden>
    <thead id="plan-header">
      <tr>
        <th>Week</th>
        <th>Monday</th>
        <th>Tuesday</th>
        <th>Wednesday</th>
        <th>Thursday</th>
        <th>Friday</th>
        <th>Saturday</th>
        <th>Sunday</th>
      </tr>
    </thead>
    <tbody id="run-info-chart">
    </tbody>
  </table>

  <form action="/sign-up">
    <input type="submit" id="sign-up-and-save" name="sign-up-and-save" value="Save &amp Sign-up" hidden>
  </form>

  <button type="submit" id="download-to-excel" name="download-to-excel" hidden>Download as .xlsx</button>

  <div id="calendar" hidden></div>

  <script>
  "use strict";

  
  function displayCalendar(evt) {
    $(document).ready(function() {
      // page is now ready, initialize the calendar...
      $("#calendar").removeAttr("hidden");
      $('#calendar').fullCalendar({
          // put your options and callbacks here
          firstDay: 1,
          height: 600,
          width: 100,
          // events: run_events,
          dayClick: function() {
          alert('a day has been clicked!');
          },
      });
      // function getPlanResultsForCalendar() {
      //   var currentAbility = $("#current-ability").val();
      //   var goalDistance = $("#goal-distance").val();
      //   var goalDate = $("#goal-date").val();
      //   $.post("/run-event", {"current-ability": currentAbility, 
      //                          "goal-distance": goalDistance, 
      //                          "goal-date": goalDate}, renderCalendar);
      // }
      // function renderCalendar(results) {
      //   var run_events = [];
      //   for (var i in results) {
      //     run_events.push({title: results[i], start: moment(i).format(), allDay: true});
      //   };
      //   for (var j=0; j<run_events.length; j++) {
      //     var run_event = run_events[j]
      //     $('#calendar').fullCalendar('renderEvent', run_event, true);
      //   };
      // }
    
    });
  }

  var run_event_one = {title: 3, start: moment().format(), allDay: true};
  $('#calendar').fullCalendar('renderEvent', run_event_one, true);

  function showPlanResults(results) {
    var runPlan = results
    $("#run-info-chart").empty();

    for (var week in runPlan) {
      $("#run-info-chart").append('<tr>');
      $("#run-info-chart").append('<td class="week-number">Week ' + week + '</td>');

      var weeklyPlan = runPlan[week];
      for (var date in weeklyPlan) {
        var newDate = new Date(date);
        var month = (newDate.getMonth()+1)+ "";
        var day = newDate.getDate();
        if (weeklyPlan[date]) {
          $("#run-info-chart").append('<td>  ' + month + "/" + day + '<br><br>  ' + weeklyPlan[date] + ' miles</td>');
        } else {
          $("#run-info-chart").append('<td>  ' + month + "/" + day + '<br><br>  off day</td>');
        }
      }
      $("#run-info-chart").append('</tr>');
    }
    $("#plan-calendar").removeAttr("hidden");
    
  }

  function getPlanResults(evt) {
    evt.preventDefault();
    var currentAbility = $("#current-ability").val();
    var goalDistance = $("#goal-distance").val();
    var goalDate = $("#goal-date").val();
    $.post("/plan.json", {"current-ability": currentAbility, 
                     "goal-distance": goalDistance, 
                     "goal-date": goalDate}, showPlanResults);
  }

  function displaySignUpAndSaveButton(evt) {
    evt.preventDefault();
    $("#download-to-excel").removeAttr("hidden");
    $("#sign-up-and-save").removeAttr("hidden");
  }

  function getPlanResultsForDownload(evt) {
    var currentAbility = $("#current-ability").val();
    var goalDistance = $("#goal-distance").val();
    var goalDate = $("#goal-date").val();

    // Routes to /download (download? below) with the following values from the DOM
    window.location = 'download?current-ability=' + currentAbility + 
                      '&goal-distance=' + goalDistance + '&goal-date=' + 
                      goalDate;
  }

  $("#planning-form").on('submit', getPlanResults);
  $("#planning-form").on('submit', displaySignUpAndSaveButton);
  $("#download-to-excel").on('click', getPlanResultsForDownload);
  $("#planning-form").on('submit', displayCalendar);
  </script>

{% endblock %}